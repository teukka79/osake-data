name: Paivita Osakehinnat
on:
  schedule:
    - cron: '0 * * * *' # Päivitys kerran tunnissa
  workflow_dispatch: # Sallii manuaalisen käynnistyksen painikkeesta

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Asenna Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Asenna kirjastot
        run: pip install yfinance
        
      - name: Hae hinnat
        run: |
          python - <<EOF
          import yfinance as yf
          import json

          # Kaikki salkkusi osakkeet (A-vaihtoehto)
          tickers = [
              "HUH1V.HE", "UPM.HE", "TAALA.HE", "TIETO.HE", "KESKOB.HE", 
              "SAMPO.HE", "WRT1V.HE", "VALMT.HE", "POSTI.HE", "TALLINK.TL", "TITAN.HE"
          ]
          
          # Selkeät nimet salkkunäkymää varten
          nimet = {
              "HUH1V.HE": "HUHTAMÄKI", 
              "UPM.HE": "UPM-KYMMENE", 
              "SAMPO.HE": "SAMPO",
              "WRT1V.HE": "WÄRTSILÄ", 
              "VALMT.HE": "VALMET", 
              "POSTI.HE": "POSTI",
              "TALLINK.TL": "TALLINK", 
              "TITAN.HE": "TITANIUM", 
              "TAALA.HE": "TAALERI",
              "TIETO.HE": "TIETOEVRY", 
              "KESKOB.HE": "KESKO B"
          }
          
          data = []
          for t in tickers:
              try:
                  stock = yf.Ticker(t)
                  # Haetaan tuorein hinta
                  price = stock.fast_info['last_price']
                  name = nimet.get(t, t.split('.')[0])
                  data.append({
                      "nimi": name, 
                      "hinta": round(price, 2)
                  })
              except Exception as e:
                  print(f"Virhe tickerillä {t}: {e}")
                  continue

          # Tallennetaan hinnat.json tiedostoon
          with open('hinnat.json', 'w') as f:
              json.dump(data, f, indent=4)
          EOF
          
      - name: Tallenna muutokset GitHubiin
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add hinnat.json
          git commit -m "v54 Masterpiece: Hintapäivitys suoritettu" || exit 0
          git push
